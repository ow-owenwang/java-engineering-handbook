# 监听器

监听器是一种专门用于对其他对象身上发生的事件或状态改变进行监听和相应处理的对象，当被监视的对象发生情况时，立即采取相应的行动。

Servlet 监听器可以监听 web 应用程序中的 ServletContext、HttpSession 和 ServletRequest 等域对象的创建与销毁事件，以及监听这些域对象中的属性发生修改的事件。

按监听的事件类型 Servlet 监听器可分为如下三种类型：

监听域对象自身的创建和销毁的事件监听器

监听域对象中的属性的增加和删除的事件监听器

监听绑定到 HttpSession 域中的某个对象的状态的事件监听器

Servlet 规范为每种事件监听器都定义了相应的接口，开发人员编写的事件监听器程序只需实现这些接口，web 服务器根据编写的事件监听器所实现的接口把它注册到相应的被监听的对象上

一些 Servlet 事件监听器需要在 web 应用程序的 web.xml 文件中进行注册，一个 web.xml 文件中可以注册多个 Servlet 事件监听器，web 服务器按照它们在 web.xml 文件中的注册顺序来加载和注册这些 Serlvet 事件监听器。

Serlvet 事件监听器的注册和调用过程都是由 web 容器自动完成的，当发生被监听的对象被创建，修改或销毁事件时，web容器将调用与之相关的 Servlet 事件监听器对象的相关方法，开发人员在在这些方法中编写的事件处理代码即被执行

由于一个 web 应用程序只会为每个事件监听器创建一个对象，有可能出现多个线程同时调用同一个事件监听器对象的情况，所以，在编写事件监听器类时，应考虑多线程安全的问题

域对象创建和销毁的事件监听器就是用来监听 ServletContext、HttpSession、HttpServletRequest 这三个对象的创建和销毁事件的监听器。

ServletContext对象在 WEB 服务器启动时创建，每个 WEB 应用对应唯一的一个对象，而当服务器关闭时会自动销毁每一个ServletContext对象。

HttpSersion对象在浏览器与服务器建立会话时创建，当调用invalidate()方法、超过 Session 最大有效时间或者服务器进程停止时销毁。

ServletRequest对象在每次请求到达服务器时创建，每次请求结束后销毁。

ServletContextListener 接口用于监听 ServletContext 对象的创建和销毁事件。

当 ServletContext 对象被创建时，激发contextInitialized (ServletContextEvent sce)方法

当 ServletContext 对象被销毁时，激发contextDestroyed(ServletContextEvent sce)方法

HttpSessionListener 接口用于监听HttpSession对象的创建和销毁

创建一个Session时，激发sessionCreated

(HttpSessionEvent se) 方法

销毁一个Session时，激发sessionDestroyed (HttpSessionEvent se) 方法。

ServletRequestListener 接口用于监听ServletRequest 对象的创建和销毁

创建一个ServletRequest 对象时，激发requestInitialized(ServletRequestEvent sre)方法

销毁一个Session时，激发requestDestroyed(ServletRequestEvent sre)方法。

监听域对象中属性变化的监听器接口有ServletContextAttributeListener、HttpSessionAttributeListener、ServletRequestAttributeListener，分别用来监听ServletContext、HttpSession、HttpServletRequest，这三个接口中都定义了三个方法来处理被监听对象中的属性的增加，删除和替换的事件，同一个事件在这三个接口中对应的方法名称完全相同，只是接受的参数类型不同。

当向被监听器对象中增加一个属性时，web容器就调用事件监听器的 attributeAdded 方法，这个方法接受一个事件类型的参数，监听器可以通过这个参数来获得正在增加属性的域对象和被保存到域中的属性对象

当删除被监听对象中的一个属性时，web 容器调用事件监听器的 attributeRemoved 方法

当监听器的域对象中的某个属性被替换时，web容器调用事件监听器的这个方法 attributeReplaced

保存在 Session 域中的对象可以有多种状态：绑定到 Session 中；从 Session 域中解除绑定；随 Session 对象持久化到一个存储设备中；随 Session 对象从一个存储设备中恢复

Servlet 规范中定义了两个特殊的监听器接口来帮助 JavaBean 对象了解自己在 Session 域中的这些状态：HttpSessionBindingListener接口和HttpSessionActivationListener接口 ，实现这两个接口的类不需要 web.xml 文件中进行注册

实现了HttpSessionBindingListener接口的 JavaBean 对象可以感知自己被绑定到 Session 中和从 Session 中删除的事件

当对象被绑定到 HttpSession 对象中时，web 服务器调用该对象的 void valueBound(HttpSessionBindingEvent event) 方法，用来统计在线人数？！

当对象从 HttpSession 对象中解除绑定时，web 服务器调用该对象的 void valueUnbound(HttpSessionBindingEvent event)方法

实现了HttpSessionBindingListener接口的 JavaBean 对象可以感知自己被活化和钝化的事件

当绑定到 HttpSession 对象中的对象将要随 HttpSession 对象被钝化之前，web 服务器调用该对象的 void sessionWillPassivate(HttpSessionBindingEvent event) 方法

当绑定到 HttpSession 对象中的对象将要随 HttpSession 对象被活化之后，web 服务器调用该对象的 void sessionDidActive(HttpSessionBindingEvent event)方法

HttpSessionActivationListener：监听实现了该接口和 Serializable 接口的 Java 类的对象随 session 钝化和活化事件。该监听器不需要在 web.xml 文件中进行配置。

监听器同样可以通过 xml 或者注解来配置。

配置 xml 文件：

<listener>  <listener-class>org.example.listener.MyListener</listener-class></listener>

注解方式：

@WebListenerpublic class MyListener implements ServletContextListener, HttpSessionListener, HttpSessionAttributeListener {    public MyListener() {    }    @Override    public void contextInitialized(ServletContextEvent sce) {        /* This method is called when the servlet context is initialized(when the Web application is deployed). */    }    @Override    public void contextDestroyed(ServletContextEvent sce) {        /* This method is called when the servlet Context is undeployed or Application Server shuts down. */    }    @Override    public void sessionCreated(HttpSessionEvent se) {        /* Session is created. */    }    @Override    public void sessionDestroyed(HttpSessionEvent se) {        /* Session is destroyed. */    }    @Override    public void attributeAdded(HttpSessionBindingEvent sbe) {        /* This method is called when an attribute is added to a session. */    }    @Override    public void attributeRemoved(HttpSessionBindingEvent sbe) {        /* This method is called when an attribute is removed from a session. */    }    @Override    public void attributeReplaced(HttpSessionBindingEvent sbe) {        /* This method is called when an attribute is replaced in a session. */    }}

contextInitialized() 方法会监听 ServletContext 对象的创建，创建成功后此方法会自动执行。而当服务器正常关闭时会调用 contextDestroyed() 方法。